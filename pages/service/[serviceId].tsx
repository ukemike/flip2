import React from 'react'
import type { NextPage } from 'next'
import Head from 'next/head'
import "react-multi-carousel/lib/styles.css";
import Nav from '../../src/components/web/nav/Nav'
import ServiceDetailsComponent from '../../src/components/web/service/ServiceDetails'
import NewsLetter from '../../src/components/web/newsLetter/NewsLetter'
import Footer from '../../src/components/web/footer/Footer'
import { GetStaticProps } from 'next'
import { getSingleService, getServicesByCategory, requestService, clearError, clearMessage } from '../../src/redux/features/serviceSlice'
import { sendMesage, clearMessageChat, clearErrorChat } from '../../src/redux/features/messageSlice'
import { useAppSelector, useAppDispatch } from '../../src/redux/hooks'
import { useEffect, useState, useCallback } from 'react'
import AlertModal from '../../src/components/alert/Alert'
import { useRouter } from 'next/router'

const ServiceDetails: NextPage = (props: any) => {
    const dispatch = useAppDispatch()
    const router = useRouter()

    const { service, services, loadingFetchServices, success, error, message, loading } = useAppSelector(state => state.service)

    const { loading: loadingChatMessage, error: errorChatMessage, success: successChatMessage, message: messageChatMessage, } = useAppSelector((state) => state.message)

    const [serviceCategoryId, setServiceCategoryId] = useState(Number)

    const fetchServiceAndServicesByCategory = useCallback(() => {
        dispatch(getSingleService(props.serviceId))
        dispatch(getServicesByCategory(serviceCategoryId))
    }, [dispatch, props.serviceId, serviceCategoryId])

    useEffect(() => {
        fetchServiceAndServicesByCategory()
    }, [fetchServiceAndServicesByCategory])

    useEffect(() => {
        if (service && service.category) {
            setServiceCategoryId(service.category.categoryID)
        }
    }, [service])

    const handleRequestService = useCallback((data: any) => {
        dispatch(requestService(data))
    }, [dispatch])

    const handleSendMessage = useCallback((data: any) => {
        dispatch(sendMesage(data))
    }, [dispatch])

    return (
        <div>
            <Head>
                <title>Flip</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/flip-favicon.png" />
            </Head>

            <Nav />

            <section className="bg-white w-full h-full">

                <div className='container mx-auto px-4 md:px-10'>

                    <ServiceDetailsComponent
                        service={service}
                        services={services}
                        loadingFetchServices={loadingFetchServices}
                        requestService={handleRequestService}
                        loading={loading}
                        sendMesage={handleSendMessage}
                        loadingChatMessage={loadingChatMessage}
                    />

                    {error &&
                        <AlertModal
                            title='Error'
                            message={error}
                            confirmButtonText="Ok"
                            type="error"
                            onConfirm={() => {
                                dispatch(clearError())
                            }}
                        />
                    }

                    {success &&
                        <AlertModal
                            title='Success'
                            message={message || messageChatMessage}
                            confirmButtonText="Back to Homepage"
                            type="success"
                            onConfirm={() => {
                                dispatch(clearMessage())
                                router.push('/')
                            }}
                        />
                    }

                    {errorChatMessage &&
                        <AlertModal
                            title='Error'
                            message={errorChatMessage}
                            confirmButtonText="Ok"
                            type="error"
                            onConfirm={() => {
                                dispatch(clearErrorChat())
                            }}
                        />
                    }

                    {successChatMessage &&
                        <AlertModal
                            title='Success'
                            message={messageChatMessage}
                            confirmButtonText="Back to Homepage"
                            type="success"
                            onConfirm={() => {
                                dispatch(clearMessageChat())
                                router.push('/')
                            }}
                        />
                    }


                    <NewsLetter />

                    <div className="pt-20"></div>


                </div>

            </section>

            <footer className="bg-backg w-full h-full">
                <Footer />
            </footer>

        </div>
    )
}


export const getServerSideProps: GetStaticProps = async (context: any) => {
    const serviceId = context.params.serviceId
    return {
        props: {
            serviceId: serviceId
        }
    }
}
export default ServiceDetails